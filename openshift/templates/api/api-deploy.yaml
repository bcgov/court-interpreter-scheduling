---
kind: Template
apiVersion: v1
metadata:
  name: ${NAME}-deployment-template
  annotations:
    description:
      Deployment template for a fastapi server connected to a PostGreSQL
      database.
    tags: fastapi
    iconClass: icon-python
objects:
  - kind: NetworkPolicy
    apiVersion: networking.k8s.io/v1
    metadata:
      name: ${NAME}
      labels:
        name: ${NAME}
        app: ${APP_NAME}
        env: ${TAG_NAME}
    spec:
      description: |
        Allow the front-end application to access the API.
      ingress:
        - from:
            - podSelector:
                matchLabels:
                  role: web
                  app: ${APP_NAME}
                  env: ${TAG_NAME}
              namespaceSelector:
                matchLabels:
                  name: ${NAMESPACE_NAME}
                  environment: ${TAG_NAME}
          ports:
            - protocol: TCP
              port: 8080
      podSelector:
        matchLabels:
          role: ${ROLE}
          app: ${APP_NAME}
          env: ${TAG_NAME}

  # - kind: ExternalNetwork
  #   apiVersion: security.devops.gov.bc.ca/v1alpha1
  #   metadata:
  #     name: ${NAME}
  #     network: ${NAME}
  #     labels:
  #       name: ${NAME}
  #       network: ${NAME}
  #       app: ${APP_NAME}
  #       env: ${TAG_NAME}
  #   spec:
  #     description: |
  #       Define the network parameters for accessing remote resources.
  #     entries:
  #       - ${OIDC_RP_HOST}
  #     servicePorts:
  #       - tcp/443

  # - kind: NetworkSecurityPolicy
  #   apiVersion: security.devops.gov.bc.ca/v1alpha1
  #   metadata:
  #     name: ${NAME}
  #     labels:
  #       name: ${NAME}
  #       app: ${APP_NAME}
  #       env: ${TAG_NAME}
  #   spec:
  #     description: |
  #       Allow the application's API to talk to either the database or pdf microservice, plus a defined set of external resources.
  #     source:
  #       - - role=${ROLE}
  #         - app=${APP_NAME}
  #         - env=${TAG_NAME}
  #         - $namespace=${NAMESPACE_NAME}-${TAG_NAME}
  #     destination:
  #       - - role=db
  #         - app=${APP_NAME}
  #         - env=${TAG_NAME}
  #         - $namespace=${NAMESPACE_NAME}-${TAG_NAME}
  #       - - role=pdf
  #         - app=${APP_NAME}
  #         - env=${TAG_NAME}
  #         - $namespace=${NAMESPACE_NAME}-${TAG_NAME}
  #       - - ext:name=${NAME}

  - kind: Service
    apiVersion: v1
    metadata:
      name: ${NAME}
      labels:
        name: ${NAME}
        app: ${APP_NAME}
        role: ${ROLE}
        env: ${TAG_NAME}
      annotations:
        description: Exposes and load balances the application pods
        service.alpha.openshift.io/dependencies: "[{name: ${DATABASE_SERVICE_NAME}, kind: Service}]"
    spec:
      ports:
        - name: 8080-tcp
          port: 8080
          targetPort: 8080
      selector:
        name: ${NAME}

  - kind: Secret
    apiVersion: v1
    metadata:
      name: ${NAME}
      labels:
        name: ${NAME}
        app: ${APP_NAME}
        role: ${ROLE}
        env: ${TAG_NAME}
    stringData:
      OIDC_RP_CLIENT_SECRET: ${OIDC_RP_CLIENT_SECRET}
      DATA_SECURITY_KEY: ${DATA_SECURITY_KEY}
      efiling-auth-url: ${EFILING_HUB_KEYCLOAK_BASE_URL}
      efiling-auth-realm: ${EFILING_HUB_KEYCLOAK_REALM}
      efiling-client-id: ${EFILING_HUB_KEYCLOAK_CLIENT_ID}
      efiling-client-secret: ${EFILING_HUB_KEYCLOAK_SECRET}
      efiling-base-url: ${EFILING_HUB_API_BASE_URL}
      JC_INTERFACE_API_LOCATION_URL: ${JC_INTERFACE_API_LOCATION_URL}
      JC_INTERFACE_API_USERNAME: ${JC_INTERFACE_API_USERNAME}
      JC_INTERFACE_API_PASSWORD: ${JC_INTERFACE_API_PASSWORD}
      OIDC_RP_PROVIDER_REALM: ${OIDC_RP_PROVIDER_REALM}
      OIDC_RP_PROVIDER_URL: ${OIDC_RP_PROVIDER_URL}
      OIDC_RP_CLIENT_ID: ${OIDC_RP_CLIENT_ID}
      GOOGLE_MAP_URL: ${GOOGLE_MAP_URL}
      JWT_SECRET_KEY: ${JWT_SECRET_KEY}
      EMAIL_SERVICE_CLIENT_ID: ${EMAIL_SERVICE_CLIENT_ID}
      EMAIL_SERVICE_CLIENT_SECRET: ${EMAIL_SERVICE_CLIENT_SECRET}
      CHES_EMAIL_URL: ${CHES_EMAIL_URL}
      CHES_AUTH_URL: ${CHES_AUTH_URL}
      JC_INTERFACE_API_FILE_URL: ${JC_INTERFACE_API_FILE_URL}
      JC_INTERFACE_API_FILE_USERNAME: ${JC_INTERFACE_API_FILE_USERNAME}
      JC_INTERFACE_API_FILE_PASSWORD: ${JC_INTERFACE_API_FILE_PASSWORD}
      JC_INTERFACE_FILE_PART_ID: ${JC_INTERFACE_FILE_PART_ID}
      JC_INTERFACE_FILE_AGENCY_ID: ${JC_INTERFACE_FILE_AGENCY_ID}
    type: Opaque

  - kind: DeploymentConfig
    apiVersion: v1
    metadata:
      name: ${NAME}
      labels:
        name: ${NAME}
        app: ${APP_NAME}
        role: ${ROLE}
        env: ${TAG_NAME}
      annotations:
        description: Defines how to deploy the application server
    spec:
      strategy:
        type: Rolling
      triggers:
        - type: ImageChange
          imageChangeParams:
            automatic: true
            containerNames:
              - ${NAME}
            from:
              kind: ImageStreamTag
              namespace: ${IMAGE_NAMESPACE}
              name: ${NAME}:${TAG_NAME}
        - type: ConfigChange
      replicas: 1
      selector:
        name: ${NAME}
      template:
        metadata:
          name: ${NAME}
          labels:
            name: ${NAME}
            app: ${APP_NAME}
            role: ${ROLE}
            env: ${TAG_NAME}
        spec:
          containers:
            - name: ${NAME}
              image:
              ports:
                - containerPort: 8080
                  protocol: TCP
              readinessProbe:
                initialDelaySeconds: 3
                timeoutSeconds: 30
                httpGet:
                  path: /api/v1/health
                  port: 8080
                  scheme: HTTP
              livenessProbe:
                initialDelaySeconds: 120
                timeoutSeconds: 30
                httpGet:
                  path: /api/v1/health
                  port: 8080
                  scheme: HTTP
              lifecycle:
                preStop:
                  exec:
                    command:
                      - /bin/sleep
                      - '20'
              env:
                - name: DATABASE_SERVICE_NAME
                  value: ${DATABASE_SERVICE_NAME}
                - name: DATABASE_ENGINE
                  value: ${DATABASE_ENGINE}
                - name: DATABASE_NAME
                  valueFrom:
                    secretKeyRef:
                      name: ${DATABASE_DEPLOYMENT_NAME}
                      key: database-name
                - name: DATABASE_USER
                  valueFrom:
                    secretKeyRef:
                      name: ${DATABASE_DEPLOYMENT_NAME}
                      key: database-user
                - name: DATABASE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: ${DATABASE_DEPLOYMENT_NAME}
                      key: database-password
                - name: DB_SERVICE_HOST
                  value: ${DB_SERVICE_HOST}
                - name: DB_SERVICE_PORT
                  value: ${DB_SERVICE_PORT}
                - name: ADM_RECIPIENT_EMAILS
                  value: ${ADM_RECIPIENT_EMAILS}
                - name: PDF_SERVICE_URL
                  value: ${PDF_SERVICE_URL}
                - name: EFILING_ENABLED
                  value: ${EFILING_ENABLED}
                - name: OIDC_RP_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: OIDC_RP_CLIENT_SECRET
                - name: OIDC_RP_KC_IDP_HINT
                  value: ${OIDC_RP_KC_IDP_HINT}

                - name: DATA_SECURITY_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: DATA_SECURITY_KEY

                - name: EFILING_HUB_KEYCLOAK_BASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: efiling-auth-url
                - name: EFILING_HUB_KEYCLOAK_REALM
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: efiling-auth-realm
                - name: EFILING_HUB_KEYCLOAK_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: efiling-client-id
                - name: EFILING_HUB_KEYCLOAK_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: efiling-client-secret
                - name: EFILING_HUB_API_BASE_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: efiling-base-url

                - name: JC_INTERFACE_API_LOCATION_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_API_LOCATION_URL
                - name: JC_INTERFACE_API_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_API_USERNAME
                - name: JC_INTERFACE_API_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_API_PASSWORD
                - name: DEFAULT_BASE_URL
                  value: ${DEFAULT_BASE_URL}
                - name: OPENROAD_MAP_URL
                  value: ${OPENROAD_MAP_URL}
                - name: URL_SCHEME
                  value: ${URL_SCHEME}
                - name: OIDC_RP_PROVIDER_REALM
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: OIDC_RP_PROVIDER_REALM
                - name: OIDC_RP_PROVIDER_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: OIDC_RP_PROVIDER_URL
                - name: OIDC_RP_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: OIDC_RP_CLIENT_ID
                - name: GOOGLE_MAP_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: GOOGLE_MAP_URL
                - name: JWT_SECRET_KEY
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JWT_SECRET_KEY
                - name: EMAIL_SERVICE_CLIENT_ID
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: EMAIL_SERVICE_CLIENT_ID
                - name: EMAIL_SERVICE_CLIENT_SECRET
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: EMAIL_SERVICE_CLIENT_SECRET
                - name: CHES_EMAIL_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: CHES_EMAIL_URL
                - name: CHES_AUTH_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: CHES_AUTH_URL
                - name: RECIPIENT_EMAILS
                  value: ${RECIPIENT_EMAILS}
                - name: JC_INTERFACE_API_FILE_URL
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_API_FILE_URL
                - name: JC_INTERFACE_API_FILE_USERNAME
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_API_FILE_USERNAME
                - name: JC_INTERFACE_API_FILE_PASSWORD
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_API_FILE_PASSWORD
                - name: JC_INTERFACE_FILE_PART_ID
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_FILE_PART_ID
                - name: JC_INTERFACE_FILE_AGENCY_ID
                  valueFrom:
                    secretKeyRef:
                      name: ${NAME}
                      key: JC_INTERFACE_FILE_AGENCY_ID
              resources:
                requests:
                  cpu: ${CPU_REQUEST}
                  memory: ${MEMORY_REQUEST}

  - kind: HorizontalPodAutoscaler
    apiVersion: autoscaling/v1
    metadata:
      name: ${NAME}
      labels:
        name: ${NAME}
        app: ${APP_NAME}
        role: ${ROLE}
        env: ${TAG_NAME}
    spec:
      scaleTargetRef:
        kind: DeploymentConfig
        name: ${NAME}
      minReplicas: ${{MIN_REPLICAS}}
      maxReplicas: ${{MAX_REPLICAS}}

parameters:
  - name: NAME
    displayName: Name
    description: The name assigned to all of the OpenShift resources associated to the server instance.
    required: true
    value: api

  - name: APP_NAME
    displayName: App Name
    description: App Name
    required: true
    value: court-interpreter-scheduling
  - name: ROLE
    displayName: Role
    description: Role
    required: true
    value: api

  - name: NAMESPACE_NAME
    displayName: Namespace Name
    description: The base namespace name for the project.
    required: true
    value: 1a7b16

  - name: IMAGE_NAMESPACE
    displayName: Image Namespace
    required: true
    description: The namespace of the OpenShift project containing the imagestream for the application.
    value: 1a7b16-tools
  - name: DATABASE_SERVICE_NAME
    displayName: Database Service Name
    description: The name of the database server/service.
    required: true
    value: db
  - name: DATABASE_ENGINE
    displayName: Database Engine
    required: true
    description: "Database engine: postgresql, mysql, or sqlite (default)."
    value: postgresql
  - name: PDF_SERVICE_URL
    displayName: PDF Service URL
    description: Internal URL to the PDF service.
    required: true
    value: http://pdf:5001
  - name: TAG_NAME
    displayName: Environment TAG name
    description: The TAG name for this environment, e.g., dev, test, prod
    value: dev
    required: true
  - name: DATABASE_DEPLOYMENT_NAME
    displayName: Database Deployment Name
    description: The name associated to the database deployment resources.  In particular, this is used to wire up the credentials associated to the database.
    required: true
    value: db

  - name: OIDC_RP_CLIENT_SECRET
    displayName: OIDC RP Client Secret
    description: OIDC RP Client Secret
    required: false
    value:
  - name: OIDC_RP_KC_IDP_HINT
    displayName: OIDC RP KeyCloak IDP Hint
    description: OIDC RP KeyCloak IDP Hint
    required: false
    value: bceid

  - name: DATA_SECURITY_KEY
    displayName: Data Security (Encryption) Key
    description: The Encryption Key for the environment.
    generate: expression
    from: "[a-zA-Z0-9]{32}"
  - name: EFILING_ENABLED
    displayName: EFILING Enable
    description: EFILING Enable
    required: false
    value: "false"
  - name: EFILING_HUB_KEYCLOAK_BASE_URL
    displayName: EFILING authentication url
    description: EFILING authentication url
    required: false
    value:
  - name: EFILING_HUB_KEYCLOAK_REALM
    displayName: EFILING Authentication Realm
    description: EFILING Authentication Realm
    required: false
    value:
  - name: EFILING_HUB_KEYCLOAK_CLIENT_ID
    displayName: EFILING Service Client Id
    description: EFILING Service Client Id
    required: false
    value:
  - name: EFILING_HUB_KEYCLOAK_SECRET
    displayName: EFILING Service Client Secret
    description: EFILING Service Client Secret
    required: false
    value:
  - name: EFILING_HUB_API_BASE_URL
    displayName: EFILING base url
    description: EFILING base url
    required: false
    value:
  - name: JC_INTERFACE_API_LOCATION_URL
    displayName: JC INTERFACE API LOCATION URL
    description: JC INTERFACE API LOCATION URL
    required: false
    value:
  - name: JC_INTERFACE_API_USERNAME
    displayName: JC INTERFACE API USERNAME
    description: JC INTERFACE API USERNAME
    required: false
    value:
  - name: JC_INTERFACE_API_PASSWORD
    displayName: JC INTERFACE API PASSWORD
    description: JC INTERFACE API PASSWORD
    required: false
    value:
  - name: DEFAULT_BASE_URL
    displayName: DEFAULT BASE URL
    description: DEFAULT BASE URL
    required: false
    value:
  - name: OPENROAD_MAP_URL
    displayName: OPENROAD MAP URL
    description: OPENROAD MAP URL
    required: false
    value:
  - name: OIDC_RP_PROVIDER_REALM
    displayName: OIDC RP PROVIDER REALM
    description: OIDC RP PROVIDER REALM
    required: false
    value:
  - name: OIDC_RP_PROVIDER_URL
    displayName: OIDC RP PROVIDER URL
    description: OIDC RP PROVIDER URL
    required: false
    value:
  - name: OIDC_RP_CLIENT_ID
    displayName: OIDC RP CLIENT ID
    description: OIDC RP CLIENT ID
    required: false
    value:
  - name: GOOGLE_MAP_URL
    displayName: GOOGLE MAP URL
    description: GOOGLE MAP URL
    required: false
    value:
  - name: JWT_SECRET_KEY
    displayName: JWT SECRET KEY
    description: JWT SECRET KEY
    required: false
    value:
  - name: EMAIL_SERVICE_CLIENT_ID
    displayName: EMAIL SERVICE CLIENT ID
    description: EMAIL SERVICE CLIENT ID
    required: false
    value:
  - name: EMAIL_SERVICE_CLIENT_SECRET
    displayName: EMAIL SERVICE CLIENT SECRET
    description: EMAIL SERVICE CLIENT SECRET
    required: false
    value:
  - name: CHES_EMAIL_URL
    displayName: CHES EMAIL URL
    description: CHES EMAIL URL
    required: false
    value:
  - name: CHES_AUTH_URL
    displayName: CHES AUTH URL
    description: CHES AUTH URL
    required: false
    value:
  - name: RECIPIENT_EMAILS
    displayName: RECIPIENT EMAILS
    description: RECIPIENT EMAILS
    required: false
    value:
  - name: URL_SCHEME
    displayName: URL Scheme
    description: URL Scheme
    required: false
    value: https
  - name: DB_SERVICE_HOST
    displayName: Database Service Host
    description: Database Service Host
    required: false
    value: db
  - name: DB_SERVICE_PORT
    displayName: Database Service Port
    description: Database Service Port
    required: false
    value: "5432"
  - name: ADM_RECIPIENT_EMAILS
    displayName: Admin Recipient Emails
    description: Admin Recipient Emails
    required: false
    value: marzieh.mehrnejad@quartech.com
  - name: JC_INTERFACE_API_FILE_URL
    displayName: JC Interface API File URL
    description: JC Interface API File URL
    required: false
    value:
  - name: JC_INTERFACE_API_FILE_USERNAME
    displayName: JC Interface API File Username
    description: JC Interface API File Username
    required: false
    value:
  - name: JC_INTERFACE_API_FILE_PASSWORD
    displayName: JC Interface API File Password
    description: JC Interface API File Password
    required: false
    value:
  - name: JC_INTERFACE_FILE_PART_ID
    displayName: JC Interface File Part ID
    description: JC Interface File Part ID
    required: false
    value:
  - name: JC_INTERFACE_FILE_AGENCY_ID
    displayName: JC Interface File Agency ID
    description: JC Interface File Agency ID
    required: false
    value:

  - name: MIN_REPLICAS
    displayName: Minimum Replicas
    description: The minimum number of pods to have running.
    required: true
    value: "3"
  - name: MAX_REPLICAS
    displayName: Maximum Replicas
    description: The maximum number of pods to have running.
    required: true
    value: "6"

  - name: CPU_REQUEST
    displayName: Resources CPU Request
    description: The resources CPU request (in cores) for this build.
    required: true
    value: 10m
  - name: MEMORY_REQUEST
    displayName: Resources Memory Request
    description: The resources Memory request (in Mi, Gi, etc) for this build.
    required: true
    value: 10Mi
